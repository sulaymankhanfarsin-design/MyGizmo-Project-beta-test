{% extends "base.html" %}

{% block title %}Dashboard - My Gizmo{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto space-y-8">
    
    <div class="bg-white dark:dark-card dark-border p-8 rounded-2xl shadow-lg border">
        <h1 class="text-3xl font-bold text-gray-800 dark:dark-text mb-2">
            Welcome back, {{ current_user.username }}!
        </h1>
        <p class="text-gray-600 dark:dark-subtext">
            Manage your account, view your subscription, and access all your tools from here.
        </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-2 space-y-8">
            
            <div class="bg-white dark:dark-card dark-border p-6 rounded-2xl shadow-lg border">
                <h2 class="text-2xl font-semibold text-gray-700 dark:dark-text mb-4">Subscription Status</h2>
                
                {% if current_user.subscription_status == 'active' %}
                    <div class="bg-teal-50 border-teal-500 border-l-4 p-4 rounded-md">
                        <p class="text-xl font-bold text-teal-700">Pro Plan</p>
                        <p class="text-gray-600">Your subscription is active. You have unlimited access to all tools.</p>
                        <button id="manage-subscription-button" class="mt-3 text-sm font-medium text-teal-600 hover:underline">
                            Manage Subscription & Billing &rarr;
                        </button>
                    </div>
                {% else %}
                    <div class="bg-gray-50 border-gray-500 border-l-4 p-4 rounded-md">
                        <p class="text-xl font-bold text-gray-700">Free Plan</p>
                        <p class="text-gray-600">You are currently on the Free plan. Upgrade to unlock all features.</p>
                        <a href="{{ url_for('home') }}#pricing" class="mt-3 inline-block bg-teal-500 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-teal-600">
                            Upgrade to Pro
                        </a>
                    </div>
                {% endif %}
            </div>

            <div class="bg-white dark:dark-card dark-border p-6 rounded-2xl shadow-lg border">
                <h2 class="text-2xl font-semibold text-gray-700 dark:dark-text mb-4">Your Recent Files</h2>
                
                {% if files %}
                    <ul class="space-y-3">
                        {% for file in files %}
                        <li class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg flex justify-between items-center transition-all hover:shadow-md">
                            <div>
                                {% if 'PDF' in file.file_type %}
                                    <span class="text-red-500">üìÑ</span>
                                {% elif 'Image' in file.file_type %}
                                    <span class="text-blue-500">üñºÔ∏è</span>
                                {% elif 'AI' in file.file_type %}
                                    <span class="text-purple-500">‚ú®</span>
                                {% else %}
                                    <span class="text-gray-500">üìÅ</span>
                                {% endif %}
                                
                                <span class="font-semibold text-gray-800 dark:dark-text ml-2">{{ file.original_filename }}</span>
                                <p class="text-sm text-gray-500 dark:dark-subtext ml-8">
                                    {{ file.file_type }} | {{ file.created_at.strftime('%Y-%m-%d %H:%M') }}
                                </p>
                            </div>
                            <a href="{{ url_for('download_file', filename=file.saved_filename) }}" class="text-teal-600 font-medium hover:underline text-sm">Download</a>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <div class="text-center py-8">
                        <p class="text-gray-500 dark:dark-subtext">You have no saved files yet.</p>
                        <p class="text-gray-500 dark:dark-subtext mt-1">Process a file from one of the tools, and it will show up here!</p>
                    </div>
                {% endif %}
                
            </div>
            </div>
        
        <div class="lg:col-span-1 space-y-8">
            
            <div class="bg-white dark:dark-card dark-border p-6 rounded-2xl shadow-lg border">
                <h2 class="text-2xl font-semibold text-gray-700 dark:dark-text mb-4">My Profile</h2>
                <div class="space-y-2">
                    <p class="text-gray-600 dark:dark-subtext"><strong>Username:</strong> {{ current_user.username }}</p>
                    <p class="text-gray-600 dark:dark-subtext"><strong>Email:</strong> {{ current_user.email }}</p>
                </div>
            </div>

            <div class="bg-white dark:dark-card dark-border p-6 rounded-2xl shadow-lg border">
                <h2 class="text-2xl font-semibold text-gray-700 dark:dark-text mb-6">Quick Access</h2>
                <div class="grid grid-cols-3 gap-4">
                    
                    <a href="{{ url_for('image_studio') }}" class="p-2 bg-gray-50 dark:hover:bg-gray-700 rounded-lg hover:shadow-md transition-shadow text-center" title="Image Studio">
                        <img src="{{ url_for('static', filename='calculator.png') }}" alt="Image Studio" class="h-12 w-12 mx-auto">
                    </a>
                    <a href="{{ url_for('file_converter') }}" class="p-2 bg-gray-50 dark:hover:bg-gray-700 rounded-lg hover:shadow-md transition-shadow text-center" title="File Converter">
                        <img src="{{ url_for('static', filename='image_to_pdf.png') }}" alt="File Converter" class="h-12 w-12 mx-auto">
                    </a>
                    <a href="{{ url_for('ai_background_remover') }}" class="p-2 bg-gray-50 dark:hover:bg-gray-700 rounded-lg hover:shadow-md transition-shadow text-center" title="AI Background Remover">
                        <svg class="h-12 w-12 mx-auto text-teal-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c.251-.04.507-.068.77-.087a21.048 21.048 0 0110.732 4.63c.31.299.5.742.5 1.218v4.318a2.25 2.25 0 01-1.659 2.193l-2.156.622a2.25 2.25 0 00-1.09 1.09l-.622 2.156a2.25 2.25 0 01-2.193 1.659H6.379a2.25 2.25 0 01-2.193-1.659l-.622-2.156a2.25 2.25 0 00-1.09-1.09l-2.156-.622a2.25 2.25 0 01-1.659-2.193V9.051c0-.476.19-.919.5-1.218a21.048 21.048 0 0110.732-4.63c.263-.019.519-.047.77-.087z" /></svg>
                    </a>
                    <a href="{{ url_for('qr_generator') }}" class="p-2 bg-gray-50 dark:hover:bg-gray-700 rounded-lg hover:shadow-md transition-shadow text-center" title="QR Generator">
                        <img src="{{ url_for('static', filename='QRcode-logo.png') }}" alt="QR Generator" class="h-12 w-12 mx-auto">
                    </a>
                    <a href="{{ url_for('slug_generator') }}" class="p-2 bg-gray-50 dark:hover:bg-gray-700 rounded-lg hover:shadow-md transition-shadow text-center" title="Slug Generator">
                        <img src="{{ url_for('static', filename='link.png') }}" alt="Slug Generator" class="h-12 w-12 mx-auto">
                    </a>
                    <a href="{{ url_for('list_randomizer') }}" class="p-2 bg-gray-50 dark:hover:bg-gray-700 rounded-lg hover:shadow-md transition-shadow text-center" title="List Randomizer">
                        <img src="{{ url_for('static', filename='list_randomizer.png') }}" alt="List Randomizer" class="h-12 w-12 mx-auto">
                    </a>
                    
                </div>
            </div>

        </div>

    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const manageButton = document.getElementById("manage-subscription-button");
        
        if (manageButton) {
            manageButton.addEventListener("click", async () => {
                manageButton.disabled = true;
                manageButton.textContent = "Loading...";
                try {
                    const response = await fetch("{{ url_for('create_portal_session') }}", {
                        method: "POST",
                        headers: {'Content-Type': 'application/json'}
                    });
                    const session = await response.json();
                    if (session.url) {
                        window.location.href = session.url;
                    } else if (session.error) {
                        alert(session.error);
                        manageButton.disabled = false;
                        manageButton.textContent = "Manage Subscription & Billing ‚Üí";
                    }
                } catch (error) {
                    console.error("Error:", error);
                    alert("Could not connect to subscription manager. Please try again later.");
                    manageButton.disabled = false;
                    manageButton.textContent = "Manage Subscription & Billing ‚Üí";
                }
            });
        }
    });
</script>
{% endblock %}